<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Meal Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Baloo+2:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Baloo 2', cursive; /* Cute, rounded font */
            background-color: #FFF0F5; /* Lavender blush - soft pastel */
        }
        .meal-card {
            background-color: #FFFFFF;
            border-radius: 1.5rem; /* More rounded */
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.03);
            transition: transform 0.2s ease-in-out, background-color 0.2s ease-in-out, opacity 0.2s ease-in-out;
        }
        .meal-card:hover {
            transform: translateY(-5px);
        }
        .meal-card.eaten { /* Style for eaten meals */
            background-color: #E6FFFA; /* A light mint green for eaten items */
            opacity: 0.7;
        }
        .meal-time {
            font-size: 0.9rem;
            color: #FF69B4; /* Hot pink for time - playful */
        }
        .meal-name {
            font-size: 1.5rem; /* Larger meal name */
            font-weight: 700;
            color: #333;
            margin-top: 0.25rem;
            margin-bottom: 0.5rem;
        }
        .meal-note {
            font-size: 0.8rem;
            color: #6B7280; /* Gray for notes */
            font-family: 'Inter', sans-serif; /* More readable for notes */
        }
        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 1.1rem;
            color: #4B5563; /* Darker gray for checkbox label */
        }
        .checkbox-custom {
            width: 1.75rem; /* Larger checkbox */
            height: 1.75rem;
            border: 2px solid #FFB6C1; /* Light pink border */
            border-radius: 0.5rem; /* Rounded checkbox */
            margin-right: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .checkbox-custom svg {
            display: none;
            width: 1.25rem;
            height: 1.25rem;
            stroke: white;
        }
        input[type="checkbox"]:checked + .checkbox-label .checkbox-custom {
            background-color: #34D399; /* Green when checked */
            border-color: #34D399;
        }
        input[type="checkbox"]:checked + .checkbox-label .checkbox-custom svg {
            display: block;
        }
        input[type="checkbox"] {
            display: none; /* Hide original checkbox */
        }
        .header-icon {
            font-size: 3rem; /* Larger icon */
            margin-bottom: 0.5rem;
        }
        .loading-indicator, .error-message {
            text-align: center;
            padding: 2rem;
            font-size: 1.2rem;
            color: #FF69B4;
            border-radius: 1rem;
            background-color: white;
            margin: 1rem;
        }
        .error-message {
            color: #EF4444; /* Red for errors */
        }
        #userIdDisplay {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 0.75rem;
            color: #333;
            font-family: 'Inter', sans-serif;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4 sm:p-6">

    <div id="userIdDisplay" style="display: none;">User ID: <span id="currentUserId"></span></div>

    <div class="w-full max-w-2xl">
        <header class="text-center mb-8">
            <div class="header-icon">üçì</div>
            <h1 class="text-4xl font-bold text-pink-500">My Daily Meals</h1>
            <p class="text-gray-600 mt-2">Let's track our yummy food today!</p>
        </header>

        <main id="mealSchedule">
            <div class="loading-indicator">Loading meals... üß∏ Please wait.</div>
        </main>

        <footer class="text-center mt-10 mb-6">
            <p class="text-sm text-pink-400">&copy; 2025 Fun Meal Times</p>
        </footer>
    </div>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


        const firebaseConfig = {
        apiKey: "AIzaSyDG_xGcjbjOP5au93izZJ6msNU1jOyK1DM",
        authDomain: "my-daughter-s-meal-tracker.firebaseapp.com",
        projectId: "my-daughter-s-meal-tracker",
        storageBucket: "my-daughter-s-meal-tracker.firebasestorage.app",
        messagingSenderId: "800671628965",
        appId: "1:800671628965:web:fb8005c1a66a4fed3f574c"
        };

        // --- Firebase Configuration ---
        const firebaseConfigJSON = JSON.stringify(firebaseConfig);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-meal-tracker-app';

        let app;
        let auth;
        let db;
        let userId;
        let mealStatusDocRef;
        let isAuthReady = false; // Flag to track if initial auth check is complete

        // --- Meal Data (Source of Truth for UI structure) ---
        const mealData = [
            // Giving each item a unique, persistent ID for Firestore keys
            { id: "event-wakeup", time: "6:00 AM", event: "Wake Up", type: "event", icon: "‚òÄÔ∏è" },
            { id: "meal-snack1", time: "6:30 AM - 7:00 AM", name: "Snack 1 (Morning Snack)", note: "Gap until school is 1 hour.", type: "meal", icon: "ü•õ" },
            { id: "event-school", time: "8:00 AM", event: "Go to School", type: "event", icon: "üéí" },
            { id: "meal-snack2", time: "9:00 AM - 9:30 AM", name: "Snack 2 (School Snack)", note: "Gap until Main Course 1 is 1 hour 30 minutes.", type: "meal", icon: "üçé" },
            { id: "meal-main1", time: "11:00 AM - 11:30 AM", name: "Main Course 1 (Brunch/Early Lunch)", note: "", type: "meal", icon: "ü•™" },
            { id: "event-sparetime", time: "11:30 AM - 12:00 PM", event: "Spare time before nap", type: "event", icon: "üß∏" },
            { id: "event-nap", time: "12:00 PM - 1:30 PM", event: "Nap Time", type: "event", icon: "üò¥" },
            { id: "meal-main2", time: "2:00 PM - 2:30 PM", name: "Main Course 2 (Lunch after nap)", note: "Nap ends at 1:30 PM. Meal 30 mins after. Gap to Snack 3 is 2 hours.", type: "meal", icon: "üçù" },
            { id: "meal-snack3", time: "4:30 PM - 5:00 PM", name: "Snack 3 (Afternoon Snack)", note: "Gap to Main Course 3 is 1 hour 30 minutes.", type: "meal", icon: "üç™" },
            { id: "meal-main3", time: "6:30 PM - 7:00 PM", name: "Main Course 3 (Dinner/Last Meal)", note: "", type: "meal", icon: "üçö" },
            { id: "event-bedtime", time: "8:00 PM", event: "Bedtime", type: "event", icon: "üåô" }
        ];

        const mealScheduleContainer = document.getElementById('mealSchedule');

        // --- Initialize Firebase and Load Data ---
        async function initializeAppAndLoadData() {
            if (!firebaseConfigJSON) {
                console.error("Firebase configuration is missing (__firebase_config).");
                mealScheduleContainer.innerHTML = `<div class="error-message">üö® Error: Firebase setup is missing. Meal tracking won't save.</div>`;
                renderMealCardsStatic({}); // Render static cards if Firebase fails
                return;
            }

            let firebaseConfig;
            try {
                firebaseConfig = JSON.parse(firebaseConfigJSON);
            } catch (e) {
                console.error("Failed to parse Firebase configuration:", e);
                mealScheduleContainer.innerHTML = `<div class="error-message">üö® Error: Invalid Firebase setup. Meal tracking won't save.</div>`;
                renderMealCardsStatic({});
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug'); // For Firebase JS SDK console logging

                onAuthStateChanged(auth, async (user) => { // Made this callback async
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true; // Auth is ready
                        console.log("User authenticated. UID:", userId);
                        document.getElementById('currentUserId').textContent = userId;
                        document.getElementById('userIdDisplay').style.display = 'block';

                        // Path for storing meal statuses (private to the user)
                        const mealStatusCollectionPath = `artifacts/${appId}/users/${userId}/mealTrackerData`;
                        mealStatusDocRef = doc(db, mealStatusCollectionPath, "dailyMealStatus");

                        // Initial render of meal cards (will be updated by onSnapshot)
                        renderMealCardsDynamic({});

                        // Listen for real-time updates
                        onSnapshot(mealStatusDocRef, async (docSnap) => { // Made this callback async
                            if (!isAuthReady) {
                                console.log("onSnapshot: Auth not ready, skipping update.");
                                return; 
                            }

                            if (docSnap.exists()) {
                                console.log("Firestore data received:", docSnap.data());
                                updateUICheckboxesAndStyles(docSnap.data());
                            } else {
                                console.log("No meal status data in Firestore. Creating initial document.");
                                const initialStatuses = {};
                                mealData.filter(item => item.type === 'meal').forEach(meal => {
                                    initialStatuses[meal.id] = false; // All meals initially not eaten
                                });
                                try {
                                    await setDoc(mealStatusDocRef, { statuses: initialStatuses });
                                    console.log("Initial document created in Firestore.");
                                    // onSnapshot will trigger again with this new data, so no need to call updateUICheckboxesAndStyles here explicitly
                                } catch (error) {
                                    console.error("Error creating initial document in Firestore:", error);
                                }
                            }
                        }, (error) => {
                            console.error("Error listening to Firestore meal status: ", error);
                            mealScheduleContainer.innerHTML = `<div class="error-message">üö® Error loading meal data. Please refresh.</div>`;
                        });

                    } else {
                        isAuthReady = false; // Auth not ready
                        console.log("User is signed out. Attempting to sign in...");
                        const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if (authToken) {
                            try {
                                await signInWithCustomToken(auth, authToken);
                                console.log("Signed in with custom token.");
                            } catch (err) {
                                console.error("Error signing in with custom token:", err);
                                try {
                                    await signInAnonymously(auth);
                                    console.log("Signed in anonymously after custom token failure.");
                                } catch (anonErr) {
                                    console.error("Error signing in anonymously after token failure:", anonErr);
                                }
                            }
                        } else {
                            try {
                                await signInAnonymously(auth);
                                console.log("Signed in anonymously.");
                            } catch (err) {
                                console.error("Error signing in anonymously:", err);
                            }
                        }
                        // onAuthStateChanged will be re-triggered after sign-in attempt
                    }
                });
            } catch (error) {
                console.error("Firebase initialization error:", error);
                mealScheduleContainer.innerHTML = `<div class="error-message">üö® Error initializing. Meal tracking may not work.</div>`;
                renderMealCardsStatic({});
            }
        }

        // --- Render Meal Cards (Dynamic with event listeners) ---
        function renderMealCardsDynamic(currentStatuses = {}) {
            mealScheduleContainer.innerHTML = ''; // Clear loading/previous

            mealData.forEach(item => {
                const cardId = item.id;
                let cardHtml = '';

                if (item.type === 'meal') {
                    const isChecked = currentStatuses[cardId] === true;
                    cardHtml = `
                        <div class="meal-card ${isChecked ? 'eaten' : ''}" id="${cardId}">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="meal-time">${item.time} ${item.icon}</p>
                                    <h3 class="meal-name">${item.name}</h3>
                                </div>
                                <input type="checkbox" id="checkbox-${cardId}" data-mealid="${cardId}" ${isChecked ? 'checked' : ''}>
                                <label for="checkbox-${cardId}" class="checkbox-label">
                                    <span class="checkbox-custom">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                                        </svg>
                                    </span>
                                    Eaten
                                </label>
                            </div>
                            ${item.note ? `<p class="meal-note mt-3">${item.note}</p>` : ''}
                        </div>
                    `;
                } else { // type === 'event'
                    cardHtml = `
                        <div class="meal-card bg-pink-50 border-l-4 border-pink-400" id="${cardId}">
                            <div class="flex items-center">
                                <span class="text-2xl mr-3">${item.icon}</span>
                                <div>
                                    <p class="meal-time text-pink-500 font-semibold">${item.time}</p>
                                    <h3 class="text-lg font-semibold text-pink-700">${item.event}</h3>
                                </div>
                            </div>
                        </div>
                    `;
                }
                mealScheduleContainer.innerHTML += cardHtml;
            });

            // Add event listeners to checkboxes after they are rendered
            mealData.filter(item => item.type === 'meal').forEach(meal => {
                const checkbox = document.getElementById(`checkbox-${meal.id}`);
                if (checkbox) {
                    checkbox.addEventListener('change', handleMealCheckChange);
                }
            });
        }
        
        // --- Render Meal Cards (Static, if Firebase fails) ---
        function renderMealCardsStatic(currentStatuses = {}) {
            mealScheduleContainer.innerHTML = ''; // Clear loading/previous

            mealData.forEach(item => {
                const cardId = item.id;
                let cardHtml = '';

                if (item.type === 'meal') {
                    const isChecked = currentStatuses[cardId] === true; // Won't persist
                    cardHtml = `
                        <div class="meal-card ${isChecked ? 'eaten' : ''}" id="${cardId}">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="meal-time">${item.time} ${item.icon}</p>
                                    <h3 class="meal-name">${item.name}</h3>
                                </div>
                                <input type="checkbox" id="checkbox-${cardId}" ${isChecked ? 'checked' : ''} disabled>
                                <label for="checkbox-${cardId}" class="checkbox-label opacity-50">
                                    <span class="checkbox-custom">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                                        </svg>
                                    </span>
                                    Eaten (Offline)
                                </label>
                            </div>
                            ${item.note ? `<p class="meal-note mt-3">${item.note}</p>` : ''}
                        </div>
                    `;
                } else { // type === 'event'
                     cardHtml = `
                        <div class="meal-card bg-pink-50 border-l-4 border-pink-400" id="${cardId}">
                            <div class="flex items-center">
                                <span class="text-2xl mr-3">${item.icon}</span>
                                <div>
                                    <p class="meal-time text-pink-500 font-semibold">${item.time}</p>
                                    <h3 class="text-lg font-semibold text-pink-700">${item.event}</h3>
                                </div>
                            </div>
                        </div>
                    `;
                }
                mealScheduleContainer.innerHTML += cardHtml;
            });
        }


        // --- Update UI Checkboxes and Card Styles based on Firestore data ---
        function updateUICheckboxesAndStyles(dataFromFirestore) {
            const statuses = dataFromFirestore && dataFromFirestore.statuses ? dataFromFirestore.statuses : {};
            mealData.filter(item => item.type === 'meal').forEach(meal => {
                const checkbox = document.getElementById(`checkbox-${meal.id}`);
                const cardElement = document.getElementById(meal.id);
                if (checkbox && cardElement) {
                    const isChecked = statuses[meal.id] === true;
                    checkbox.checked = isChecked;
                    if (isChecked) {
                        cardElement.classList.add('eaten');
                    } else {
                        cardElement.classList.remove('eaten');
                    }
                } else {
                    // This can happen if onSnapshot fires before renderMealCardsDynamic has completed.
                    // console.warn(`Checkbox or card element not found for meal.id: ${meal.id} during UI update.`);
                }
            });
        }

        // --- Handle Checkbox Change and Update Firestore ---
        async function handleMealCheckChange(event) {
            if (!isAuthReady || !mealStatusDocRef) {
                console.warn("Auth not ready or Firestore doc ref not set. Cannot save meal status.");
                // Optionally revert checkbox and show a message
                event.target.checked = !event.target.checked; 
                // Using a custom modal or non-blocking notification is better than alert()
                // For now, just console log the issue.
                console.error("Could not save change. Please check your connection or try again later. Auth/DB not ready.");
                return;
            }

            const mealId = event.target.dataset.mealid;
            const isChecked = event.target.checked;

            console.log(`Meal ${mealId} status changed to: ${isChecked}`);

            try {
                const docSnap = await getDoc(mealStatusDocRef);
                const currentStatuses = docSnap.exists() && docSnap.data().statuses ? docSnap.data().statuses : {};
                currentStatuses[mealId] = isChecked;

                await setDoc(mealStatusDocRef, { statuses: currentStatuses }, { merge: true }); 
                console.log(`Meal ${mealId} status updated in Firestore.`);
                
                // UI update is primarily handled by onSnapshot for consistency,
                // but for immediate visual feedback, we can apply it here too.
                const cardElement = document.getElementById(mealId);
                if (cardElement) {
                    if (isChecked) {
                        cardElement.classList.add('eaten');
                    } else {
                        cardElement.classList.remove('eaten');
                    }
                }

            } catch (error) {
                console.error("Error updating meal status in Firestore:", error);
                // Revert checkbox state on error
                event.target.checked = !isChecked; 
                const cardElement = document.getElementById(mealId);
                 if (cardElement) { 
                    if (event.target.checked) cardElement.classList.add('eaten');
                    else cardElement.classList.remove('eaten');
                }
                // Using a custom modal or non-blocking notification is better than alert()
                console.error("Failed to save your change. Please try again.");
            }
        }

        // --- Start the application ---
        initializeAppAndLoadData();

    </script>

</body>
</html>
